// Generated by CoffeeScript 1.3.3
var COMPLETE_UPDATE, DEQUEUE_UPDATE, QUEUE_VIEW, completeJob, db, dequeueJob, es, http, job, queueJob, request, status;

COMPLETE_UPDATE = "/_design/complete/_update/id/";

DEQUEUE_UPDATE = "/_design/dequeue/_update/id/";

QUEUE_VIEW = "/_design/queued/_view/name";

request = require('request');

http = require('http');

es = require('event-stream');

db = process.env.DB_URL || 'http://jackhq:jackdog63@gmms.iriscouch.com/cloudq';

module.exports = function() {
  return http.createServer(function(req, res) {
    var _ref;
    _ref = req.url.split('/'), req.root = _ref[0], req.queue = _ref[1], req.queueId = _ref[2];
    if (req.method === 'POST') {
      return queueJob(req, res);
    } else if (req.method === 'DELETE') {
      return completeJob(req, res);
    } else if (req.method === 'GET') {
      return dequeueJob(req, res);
    } else {
      return status(res, 'Feature Not Implemented');
    }
  }).listen(process.env.PORT || 3000);
};

queueJob = function(req, res) {
  var jobify;
  jobify = function(data, cb) {
    var json, _ref;
    json = JSON.parse(data.toString());
    json.queue = req.queue;
    json.queue_state = 'queued';
    if ((_ref = json.priority) == null) {
      json.priority = 1;
    }
    return cb(null, JSON.stringify(json));
  };
  return req.pipe(es.pipe(es.map(jobify), request.post(db, {
    json: true
  }))).pipe(res);
};

dequeueJob = function(req, res) {
  var view;
  view = QUEUE_VIEW + ("?key=%22" + req.queue + "%22&limit=1");
  return request(db + view, {
    json: true
  }, function(e, r, b) {
    var _ref, _ref1;
    if ((b != null ? (_ref = b.rows) != null ? (_ref1 = _ref[0]) != null ? _ref1.id : void 0 : void 0 : void 0) != null) {
      return request.put({
        uri: db + DEQUEUE_UPDATE + b.rows[0].id,
        json: true
      }, function(err) {
        if (err != null) {
          return status(res, err.message);
        }
        return job(res, b.rows[0].value);
      });
    } else {
      return status(res('empty'));
    }
  });
};

completeJob = function(req, res) {
  return request.put({
    uri: db + COMPLETE_UPDATE + req.queueId,
    json: true
  }, function(err) {
    return status(res, 'complete');
  });
};

status = function(res, msg) {
  res.writeHead(200, {
    'content-type': 'application/json'
  });
  return res.end(JSON.stringify({
    status: msg
  }));
};

job = function(res, job) {
  res.writeHead(200, {
    'content-type': 'application/json'
  });
  return res.end(JSON.stringify(job));
};
