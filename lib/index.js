// Generated by CoffeeScript 1.3.3
var COMPLETE_UPDATE, DEQUEUE_UPDATE, QUEUE_VIEW, admindb, completeJob, db, dequeueJob, es, http, init, job, pin, queueJob, relax, request, status, view;

COMPLETE_UPDATE = "/_design/complete/_update/id/";

DEQUEUE_UPDATE = "/_design/dequeue/_update/id/";

QUEUE_VIEW = "/_design/queued/_view/name";

require('date-utils');

request = require('request');

http = require('http');

es = require('event-stream');

init = require(__dirname + '/init');

pin = require('linchpin');

db = process.env.DB_URL || 'http://localhost:5984/cloudq';

admindb = process.env.ADMIN_URL || 'http://localhost:5984/cloudq';

relax = request.defaults({
  json: true
});

module.exports = function(cb) {
  var start;
  if (process.env.NODE_ENV === 'production') {
    if (process.env.DB_URL == null) {
      throw new Error('DB_URL is required!');
    }
    if (process.env.ADMIN_URL == null) {
      throw new Error('ADMIN_URL is required!');
    }
  } else {
    pin.on('LOG/*', function(text) {
      return console.log(text);
    });
  }
  start = function(cb) {
    return http.createServer(function(req, res) {
      var uri, _ref, _ref1, _ref2;
      if (((_ref = req.headers) != null ? _ref.authorization : void 0) != null) {
        relax = request.defaults({
          json: true,
          headers: {
            authorization: req.headers.authorization
          }
        });
      }
      _ref1 = req.url.split('?'), uri = _ref1[0], req.params = _ref1[1];
      _ref2 = uri.split('/'), req.root = _ref2[0], req.queue = _ref2[1], req.queueId = _ref2[2];
      if (req.queue === '') {
        return status(res, 'Welcome to cloudq!');
      } else if (req.method === 'GET') {
        if (req.queue === 'api') {
          return view(req, res);
        } else {
          return dequeueJob(req, res);
        }
      } else if (req.method === 'POST') {
        return queueJob(req, res);
      } else if (req.method === 'DELETE') {
        return completeJob(req, res);
      } else {
        return status(res, 'Feature Not Implemented');
      }
    }).listen(process.env.PORT || process.env.VMC_APP_PORT || 3000, cb);
  };
  return init(admindb, function() {
    return start(cb);
  });
};

queueJob = function(req, res) {
  var jobify;
  jobify = function(data, cb) {
    var json, _ref;
    json = JSON.parse(data.toString());
    json.queue = req.queue;
    json.queue_state = 'queued';
    if ((_ref = json.priority) == null) {
      json.priority = 1;
    }
    json.expires_in = (new Date()).addDays(1);
    return cb(null, JSON.stringify(json));
  };
  return req.pipe(es.pipe(es.map(jobify), relax.put(db))).pipe(res);
};

dequeueJob = function(req, res) {
  var view;
  view = QUEUE_VIEW + ("?key=%22" + req.queue + "%22&limit=1");
  return relax(db + view, function(e, r, b) {
    var _ref, _ref1;
    if ((b != null ? (_ref = b.rows) != null ? (_ref1 = _ref[0]) != null ? _ref1.id : void 0 : void 0 : void 0) != null) {
      return relax.put({
        uri: db + DEQUEUE_UPDATE + b.rows[0].id
      }, function(err) {
        if (err != null) {
          return status(res, err.message);
        }
        try {
          b.rows[0].value.job.id = b.rows[0].id;
          return job(res, b.rows[0].value.job);
        } catch (err) {
          return status(res, 'Job Node Not found.');
        }
      });
    } else {
      return status(res, 'empty');
    }
  });
};

completeJob = function(req, res) {
  return relax.put({
    uri: db + COMPLETE_UPDATE + req.queueId
  }, function(err) {
    return status(res, 'complete');
  });
};

status = function(res, msg) {
  res.writeHead(200, {
    'content-type': 'application/json'
  });
  return res.end(JSON.stringify({
    status: msg
  }));
};

job = function(res, job) {
  res.writeHead(200, {
    'content-type': 'application/json'
  });
  return res.end(JSON.stringify(job));
};

view = function(req, res) {
  var name, uri;
  name = req.queueId;
  uri = "" + db + "/_design/" + name + "/_view/all?" + req.params;
  return relax(uri).pipe(res);
};
