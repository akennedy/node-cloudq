var flatiron = require('flatiron'),
  request = require('request'),
  ecstatic = require('ecstatic'),
  jade = require('jade.plugin'),
  app = flatiron.app;

var cloudq = 'http://localhost:5984/cloudq'

app.use(jade.plugin, { dir: __dirname + '/views'});

app.http.before = [
  ecstatic(__dirname + '/public', { autoIndex: false})
];

// cloudq web site
app.router.get('/', function(){
  var self = this;
  request(cloudq + '/_design/queues/_view/all?group=true', {json: true}, function(e,r,b){
    var queues = {};
    for(var i = 0; i < b.rows.length; i++) {
      var key = b.rows[i].key.split('-'),
        queue = key[0],
        state = key[1];
      if(!queues[queue]) { queues[queue] = {}}
      queues[queue][state] = b.rows[i].value;
    }
    app.render(self.res, 'index', { title: 'foo', queues: queues } );    
  });
});