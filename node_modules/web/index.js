var flatiron = require('flatiron'),
  request = require('request'),
  ecstatic = require('ecstatic'),
  connect = require('connect'),
  jade = require('jade.plugin'),
  app = flatiron.app;

var cloudq = process.env.COUCH || 'http://localhost:5984/cloudq'

app.use(jade.plugin, { dir: __dirname + '/views'});

app.http.before = [
  ecstatic(__dirname + '/public', { autoIndex: false}),
  function(req, res) {
    req.originalUrl = req.url;
    res.emit('next');
  },
  connect.cookieParser(),
  connect.session({secret: 'foobar'}),
  function(req, res) {
    if(!req.session.user && /admin/.test(req.url)){
      app.redirect(res, '/login');
    } else {
      res.emit('next');
    }
  }
];

// cloudq web site
app.router.get('/', function(){
  var self = this;
  request(cloudq + '/_design/queues/_view/all?group=true', {json: true}, function(e,r,b){
    var queues = {};
    for(var i = 0; i < b.rows.length; i++) {
      var key = b.rows[i].key.split('-'),
        queue = key[0],
        state = key[1];
      if(!queues[queue]) { queues[queue] = {}}
      queues[queue][state] = b.rows[i].value;
    }
    app.render(self.res, 'index', { title: 'foo', queues: queues, user: null } );    
  });
});

app.router.get('/admin', function(){
  app.render(this.res, 'admin', { user: this.req.session.user });
});

app.router.get('/login', function(){
  app.render(this.res, 'login', { user: null });
});

app.router.get('/logout', function(){
  this.req.session.user = null;
  app.redirect(this.res, '/');
});

app.router.post('/sessions', function(){
  var data = this.req.body;
  if(data.username === 'admin' && data.password === 'admin'){
    this.req.session.user = data;
    app.redirect(this.res, '/admin');
  }
});
